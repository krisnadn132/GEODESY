<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Krisna Exam System - Geodesy Admin Edition</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

<style>
:root {
  --bg: #f0f2f5;
  --card: #ffffff;
  --text: #2d3436;
  --muted: #636e72;
  --teal: #008080;
  --teal-light: #e0f2f2;
  --correct: #27ae60;
  --wrong: #d63031;
  --border: #dfe6e9;
  --admin-color: #6c5ce7;
}

* { box-sizing: border-box; font-family: 'Segoe UI', Roboto, sans-serif; }
body { margin: 0; background: var(--bg); color: var(--text); line-height: 1.6; }

header { background: var(--card); border-bottom: 3px solid var(--teal); box-shadow: 0 2px 5px rgba(0,0,0,0.05); padding: 10px 20px; position: sticky; top: 0; z-index: 1000; }
.header-inner { max-width: 1200px; margin: auto; display: flex; justify-content: space-between; align-items: center; }
h1 { margin: 0; color: var(--teal); font-size: 1.2rem; text-transform: uppercase; letter-spacing: 1px; }

.container { max-width: 1200px; margin: 20px auto; padding: 0 15px; }
.card { background: var(--card); border-radius: 8px; padding: 25px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); border: 1px solid var(--border); }

/* GRID SYSTEM */
.exam-grid { display: grid; grid-template-columns: 260px 1fr 260px; gap: 20px; align-items: start; }
.sidebar-left, .sidebar-right { position: sticky; top: 80px; background: var(--card); padding: 20px; border-radius: 8px; border: 1px solid var(--border); }
.sidebar-left { border-left: 4px solid var(--teal); }
.sidebar-right { border-right: 4px solid var(--teal); }

.timer-box { font-size: 1.8rem; font-weight: bold; text-align: center; margin: 15px 0; padding: 10px; background: var(--bg); border-radius: 5px; border: 1px solid var(--border); }

.nav-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-bottom: 20px; }
.nav-btn { padding: 8px 0; background: var(--bg); border: 1px solid var(--border); border-radius: 4px; text-align: center; cursor: pointer; font-size: 0.8rem; }
.nav-btn.answered { background: var(--teal); color: white; border-color: var(--teal); }

.option { display: block; border: 1px solid var(--border); padding: 12px 15px; border-radius: 6px; margin-bottom: 8px; cursor: pointer; transition: 0.2s; position: relative; }
.option.selected { border-color: var(--teal); background: var(--teal-light); font-weight: 600; }
.correct-view { background: #d4edda; border-color: #c3e6cb; color: #155724; }
.wrong-view { background: #f8d7da; border-color: #f5c6cb; color: #721c24; }

button { background: var(--teal); color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-weight: bold; width: 100%; }
button.secondary { background: var(--muted); }
button.danger { background: var(--wrong); }
button.admin-btn { background: var(--admin-color); width: auto; font-size: 0.8rem; padding: 5px 10px; margin-left: 5px; }

.hidden { display: none !important; }
.badge-essay { background: #e67e22; color: white; padding: 2px 6px; border-radius: 4px; font-size: 0.7rem; }

@media (max-width: 900px) {
    .exam-grid { display: block; }
    .sidebar-left, .sidebar-right { position: relative; top: 0; width: 100%; margin-bottom: 20px; }
}
</style>
</head>
<body>

<header>
  <div class="header-inner">
    <div style="display:flex; align-items:center; gap:10px;">
        <i class="fas fa-satellite-dish" style="color:var(--teal); font-size:1.5rem;"></i>
        <h1>Krisna Exam System <small style="font-size:0.6rem; opacity:0.7;">E4.1 Geodesy</small></h1>
    </div>
    <div id="userDisplay" style="font-weight:bold; color:var(--muted);"></div>
  </div>
</header>

<div class="container">
  <div id="startScreen" class="card" style="max-width:500px; margin: 40px auto; text-align:center;">
    <h2 style="color:var(--teal)">Candidate Login</h2>
    <input type="text" id="candidateName" placeholder="Full Name" style="width:100%; padding:12px; margin-bottom:15px; border:1px solid #ccc; border-radius:5px;">
    <button onclick="login()">Enter System <i class="fas fa-sign-in-alt"></i></button>
  </div>

  <div id="menuScreen" class="hidden">
    <div class="card">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
            <h3 style="margin:0;">Module Selection</h3>
            <button class="secondary" style="width:auto;" onclick="location.reload()">Logout</button>
        </div>
        
        <div id="adminInstruction" class="hidden" style="background:#eef; color:var(--admin-color); padding:10px; border-radius:5px; margin-bottom:15px; font-size:0.9rem;">
            <i class="fas fa-user-shield"></i> <strong>Admin Mode:</strong> Click the module below to view the <strong>Master Answer Key</strong>.
        </div>

        <button id="mainModuleBtn" onclick="handleModuleClick()" style="background:#fff3cd; color:#e67e22; border:2px solid #e67e22; padding:25px; font-size:1.1rem; text-align:left;">
            <i class="fas fa-book"></i> E4.1 Geodesy (4D Discipline)
        </button>
    </div>
    
    <div class="card">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
            <h3 style="margin:0;">Session History</h3>
            <div id="adminTools" class="hidden">
                <button class="admin-btn" onclick="exportCSV()"><i class="fas fa-file-csv"></i> Export</button>
                <button class="admin-btn danger" onclick="clearAllData()"><i class="fas fa-trash"></i> Wipe</button>
            </div>
        </div>
        <div style="overflow-x:auto;">
            <table style="width:100%; border-collapse:collapse; font-size:0.85rem;">
                <thead><tr style="background:#f8f9fa;">
                    <th style="padding:10px; border-bottom:1px solid #ddd; text-align:left;">Name</th>
                    <th style="padding:10px; border-bottom:1px solid #ddd; text-align:left;">Score</th>
                    <th style="padding:10px; border-bottom:1px solid #ddd; text-align:left;">Date</th>
                    <th id="adminCol" class="hidden" style="padding:10px; border-bottom:1px solid #ddd; text-align:center;">Action</th>
                </tr></thead>
                <tbody id="histBody"></tbody>
            </table>
        </div>
    </div>
  </div>

  <div id="examScreen" class="exam-grid hidden">
    <aside class="sidebar-left">
        <h3 id="displayModule">E4.1 Geodesy</h3>
        <p id="displayUser" style="font-size:0.8rem; color:var(--muted);"></p>
        <hr>
        <span style="font-size:0.75rem; text-transform:uppercase; color:var(--muted);">Time Elapsed</span>
        <div class="timer-box" id="timerDisplay">00:00</div>
        <button onclick="exitExam()" class="secondary">Exit</button>
    </aside>

    <section id="qBox"></section>

    <aside class="sidebar-right">
        <h4>Question Map</h4>
        <div id="navGrid" class="nav-grid"></div>
        <button onclick="submitExam()" style="padding:15px;">SUBMIT EXAM <i class="fas fa-paper-plane"></i></button>
    </aside>
  </div>

  <div id="resultScreen" class="hidden card">
    <div style="text-align:center; padding:20px;">
        <h2 id="resTitle">Review</h2>
        <div id="resScore" style="font-size:4rem; color:var(--teal); font-weight:800;">0%</div>
        <p id="resInfo" style="color:var(--muted);"></p>
        <button onclick="location.reload()" style="width:auto; padding:10px 30px;">Return to Menu</button>
    </div>
    <div id="reviewBox"></div>
  </div>
</div>

<script>
// DATABASE (15 MCQ + 10 Essay)
const BANK = [
    { q: "In modern geodesy, the inclusion of time as a coordinate dimension is fundamentally required because", o: ["GNSS satellites transmit time signals", "Earth’s gravity field is periodic", "Coordinates of points change due to tectonic motion and Earth orientation variations", "Ellipsoidal parameters depend on observation duration"], a: 2 },
    { q: "Which statement best explains why the geoid is classified as a physical surface?", o: ["It is defined by a constant Earth radius", "It is an equipotential surface of the Earth’s gravity field", "It is derived solely from GNSS observations", "It coincides exactly with the reference ellipsoid"], a: 1 },
    { q: "The primary purpose of a Coordinate Reference Frame (CRF) is to", o: ["Define mathematical properties of coordinates", "Provide theoretical assumptions for coordinate systems", "Realize a Coordinate Reference System using observed points", "Eliminate the need for datum transformations"], a: 2 },
    { q: "In the Earth-Centered Earth-Fixed (ECEF) coordinate system, the origin is defined at", o: ["The Earth’s geometric center", "The center of the reference ellipsoid", "The Earth’s center of mass", "The intersection of the equator and Greenwich meridian"], a: 2 },
    { q: "Which Earth Orientation Parameter describes the movement of the Earth’s rotation axis relative to the Earth’s crust?", o: ["Precession", "Nutation", "Polar motion", "Length of Day"], a: 2 },
    { q: "The transformation between the Conventional Inertial System (CIS) and the Conventional Terrestrial System (CTS) must include all the following components EXCEPT", o: ["Earth rotation", "Precession", "Nutation", "Geoid undulation"], a: 3 },
    { q: "A geodetic datum primarily establishes", o: ["The shape of the geoid", "The mathematical relationship between the Earth and the reference ellipsoid", "The local tidal reference level", "The orientation of map projections only"], a: 1 },
    { q: "Which set of parameters is required for a full three-dimensional Helmert datum transformation?", o: ["Three translations only", "Three translations and one scale", "Three translations, three rotations, and one scale", "Two rotations and five translations"], a: 2 },
    { q: "Why do different reference ellipsoids produce different geodetic coordinates for the same physical point?", o: ["Because Earth’s gravity field changes daily", "Because ellipsoids differ in size, shape, and orientation", "Because GNSS observations are random", "Because map projections are applied differently"], a: 1 },
    { q: "In a semi-dynamic datum, coordinates are", o: ["Fixed permanently in time", "Updated continuously without reference epoch", "Defined at a reference epoch and adjusted using velocity models", "Independent of tectonic deformation"], a: 2 },
    { q: "The relationship h = H + N indicates that", o: ["Orthometric height equals ellipsoidal height plus geoid height", "Ellipsoidal height equals orthometric height plus geoid undulation", "Geoid height equals orthometric height minus ellipsoidal height", "All height systems are interchangeable"], a: 1 },
    { q: "Which radius of curvature primarily controls distance computations in the east–west direction on an ellipsoid?", o: ["Meridian radius of curvature", "Mean Earth radius", "Prime vertical radius of curvature", "Geocentric radius"], a: 2 },
    { q: "Compared to planar distance computation, ellipsoidal distance computation is essential because", o: ["Planar methods cannot handle azimuths", "Ellipsoidal methods ignore Earth rotation", "Earth curvature and variable radii must be accounted for", "Planar methods require a datum"], a: 2 },
    { q: "In hydrographic surveying, converting GNSS heights to chart datum is necessary because", o: ["GNSS heights are referenced to mean sea level", "GNSS heights are orthometric by default", "GNSS heights are ellipsoidal and not physically meaningful for depths", "Chart datum is identical to the reference ellipsoid"], a: 2 },
    { q: "In practical surveying operations, datum transformation errors are often more dangerous than instrument errors because", o: ["Instrument errors cannot be modeled", "Datum errors introduce systematic offsets across the entire dataset", "Datum errors affect only vertical positioning", "Instrument errors propagate faster than datum errors"], a: 1 },
    { q: "Explain why modern geodesy must be treated as a four-dimensional discipline and describe the operational consequences if the time component is ignored.", type: "essay", e: "Modern geodesy is four-dimensional because positions change over time due to tectonic motion, Earth rotation variations, and crustal deformation. Ignoring time (epoch) causes coordinates to be ambiguous and inconsistent, leading to systematic positioning errors, especially when integrating GNSS data collected at different epochs." },
    { q: "Distinguish clearly between the geoid and the reference ellipsoid, and explain why confusing the two leads to vertical positioning errors.", type: "essay", e: "The geoid is a physical equipotential surface of the Earth’s gravity field used as the reference for orthometric height, while the reference ellipsoid is a mathematical surface used for coordinate computation. Confusing them leads to vertical errors because GNSS heights are ellipsoidal and must be corrected by geoid undulation to obtain physically meaningful heights." },
    { q: "Why is a Coordinate Reference System (CRS) insufficient on its own for practical positioning, and how does a Coordinate Reference Frame (CRF) resolve this limitation?", type: "essay", e: "A CRS defines coordinates only conceptually through models and parameters, but it has no real-world coordinates. A CRF resolves this by realizing the CRS through observed points such as GNSS stations or quasars, enabling practical positioning and transformation." },
    { q: "Explain the role of Earth Orientation Parameters (EOP) in linking satellite-based observations to positions on the Earth’s surface.", type: "essay", e: "EOP describe precession, nutation, polar motion, and Earth rotation variations, which govern how the Earth is oriented in space. They enable accurate transformation between inertial satellite coordinates and Earth-fixed terrestrial coordinates, ensuring consistency between space observations and ground positions." },
    { q: "Describe the physical meaning of the seven parameters in the Helmert transformation and why they are necessary for datum transformation.", type: "essay", e: "The three translation parameters represent shifts between datum origins, the three rotation parameters represent differences in axis orientation, and the scale parameter accounts for size differences. Together, they model how one reference ellipsoid and datum are positioned relative to another, enabling accurate coordinate transformation." },
    { q: "Why are static geodetic datums unsuitable for countries located in active tectonic regions, and how do semi-dynamic datums address this issue?", type: "essay", e: "Static datums assume fixed coordinates, which is invalid in tectonically active regions where positions change continuously. Semi-dynamic datums address this by fixing coordinates at a reference epoch while using velocity models to transform positions from other epochs." },
    { q: "Explain the significance of transforming coordinates between the observation domain and the calculation domain in geodesy.", type: "essay", e: "The observation domain represents real measurements tied to the Earth’s physical behavior, while the calculation domain uses an idealized ellipsoid for computation. Transformation between them ensures that real-world observations can be processed mathematically without losing physical meaning." },
    { q: "Why does ellipsoidal distance computation differ fundamentally from planar distance computation, and in which applications is this difference critical?", type: "essay", e: "Ellipsoidal distance computation accounts for Earth’s curvature and varying radii of curvature, whereas planar computation assumes a flat surface. The difference is critical for long-distance navigation, precise geodetic control, and satellite-based positioning, where planar assumptions cause significant errors." },
    { q: "Explain the operational importance of converting GNSS-derived ellipsoidal heights to orthometric heights in hydrographic surveying.", type: "essay", e: "GNSS provides ellipsoidal heights, but hydrographic products require depths and heights referenced to physical sea level or chart datum. Converting to orthometric height using a geoid model ensures bathymetric data are physically meaningful and safe for navigation." },
    { q: "Discuss why geodetic transformation errors often pose a greater risk to survey accuracy than instrument measurement errors.", type: "essay", e: "Instrument errors are usually small and quantifiable, while transformation errors can introduce systematic offsets due to incorrect datum, epoch, or parameter usage. Such errors propagate consistently across datasets, potentially shifting entire surveys by meters without being immediately detected." }
];

let currentUser = "";
let userAns = {};
let isAdmin = false;
let timerInterval;
let startTime;

function login() {
    let inp = document.getElementById('candidateName').value.trim();
    if(!inp) return alert("Please enter name.");
    currentUser = inp;
    isAdmin = (currentUser.toLowerCase() === 'krisna');
    
    document.getElementById('startScreen').classList.add('hidden');
    document.getElementById('menuScreen').classList.remove('hidden');
    document.getElementById('userDisplay').innerHTML = isAdmin ? `<i class="fas fa-user-shield"></i> Krisna (Admin)` : currentUser;
    
    if(isAdmin) {
        document.getElementById('adminInstruction').classList.remove('hidden');
        document.getElementById('adminTools').classList.remove('hidden');
        document.getElementById('adminCol').classList.remove('hidden');
    }
    refreshHistory();
}

function handleModuleClick() {
    if(isAdmin) showMasterKey();
    else startExam();
}

function startExam() {
    userAns = {};
    document.getElementById('menuScreen').classList.add('hidden');
    document.getElementById('examScreen').classList.remove('hidden');
    document.getElementById('displayUser').innerText = "Candidate: " + currentUser;
    renderQuestions();
    renderNav();
    startTime = Date.now();
    timerInterval = setInterval(() => {
        let diff = Math.floor((Date.now() - startTime) / 1000);
        let m = Math.floor(diff/60).toString().padStart(2,'0');
        let s = (diff%60).toString().padStart(2,'0');
        document.getElementById('timerDisplay').innerText = `${m}:${s}`;
    }, 1000);
}

function renderQuestions() {
    const box = document.getElementById('qBox');
    box.innerHTML = BANK.map((q, i) => {
        let input = '';
        if(q.type === 'essay') {
            input = `<textarea oninput="saveAns(${i}, this.value)" style="width:100%; height:120px; padding:10px; border-radius:5px; border:1px solid #ddd;">${userAns[i] || ''}</textarea>`;
        } else {
            const labels = ['A', 'B', 'C', 'D'];
            input = q.o.map((text, oi) => `
                <div class="option ${userAns[i] === oi ? 'selected' : ''}" onclick="saveAns(${i}, ${oi})">
                    <strong>${labels[oi]}.</strong> ${text}
                </div>
            `).join('');
        }
        return `<div class="card" id="q_${i}">
            <p><strong>Question ${i+1}</strong> ${q.type==='essay' ? '<span class="badge-essay">ESSAY</span>' : ''}</p>
            <p>${q.q}</p>${input}</div>`;
    }).join('');
}

function saveAns(idx, val) {
    userAns[idx] = val;
    renderNav();
    if(BANK[idx].type !== 'essay') renderQuestions();
}

function renderNav() {
    document.getElementById('navGrid').innerHTML = BANK.map((_, i) => `
        <div class="nav-btn ${userAns.hasOwnProperty(i) && userAns[i] !== "" ? 'answered' : ''}" 
             onclick="document.getElementById('q_${i}').scrollIntoView({behavior:'smooth', block:'center'})">${i+1}</div>
    `).join('');
}

function submitExam() {
    clearInterval(timerInterval);
    let score = 0;
    BANK.forEach((q, i) => {
        if(q.type === 'essay') { if(userAns[i] && userAns[i].length > 10) score++; }
        else { if(userAns[i] === q.a) score++; }
    });
    const pct = Math.round(score/BANK.length*100);
    saveRecord(pct);
    showResult(pct, `Score: ${score}/${BANK.length}`);
}

function showResult(pct, info) {
    document.getElementById('examScreen').classList.add('hidden');
    document.getElementById('resultScreen').classList.remove('hidden');
    document.getElementById('resScore').innerText = (pct === "ADMIN" ? "KEY" : pct + "%");
    document.getElementById('resInfo').innerText = info;
    
    const labels = ['A', 'B', 'C', 'D'];
    document.getElementById('reviewBox').innerHTML = BANK.map((q, i) => {
        let body = '';
        if(q.type === 'essay') {
            body = `<div style="background:#fff3e0; padding:10px; margin-bottom:5px;"><strong>Your Answer:</strong> ${userAns[i] || '-'}</div>
                    <div style="background:#e8f5e9; padding:10px;"><strong>Key:</strong> ${q.e}</div>`;
        } else {
            body = q.o.map((text, oi) => {
                let cls = (oi === q.a) ? 'correct-view' : (userAns[i] === oi ? 'wrong-view' : '');
                return `<div class="option ${cls}"><strong>${labels[oi]}.</strong> ${text} ${oi === q.a ? '✓' : ''}</div>`;
            }).join('');
        }
        return `<div class="card"><p><strong>${i+1}. ${q.q}</strong></p>${body}</div>`;
    }).join('');
}

function showMasterKey() {
    userAns = {};
    showResult("ADMIN", "Viewing Official Answers for E4.1");
    document.getElementById('resTitle').innerText = "Master Answer Key";
}

// DATA MGMT
function saveRecord(s) {
    let data = JSON.parse(localStorage.getItem('geodesy_ultimate_db') || '[]');
    data.push({n: currentUser, s: s, d: new Date().toLocaleString()});
    localStorage.setItem('geodesy_ultimate_db', JSON.stringify(data));
}

function refreshHistory() {
    let data = JSON.parse(localStorage.getItem('geodesy_ultimate_db') || '[]');
    document.getElementById('histBody').innerHTML = data.map((h, i) => ({...h, idx: i})).reverse().map(h => `
        <tr>
            <td style="padding:10px; border-bottom:1px solid #eee;">${h.n}</td>
            <td style="padding:10px; border-bottom:1px solid #eee;"><strong>${h.s}%</strong></td>
            <td style="padding:10px; border-bottom:1px solid #eee;"><small>${h.d}</small></td>
            <td class="${isAdmin?'':'hidden'}" style="text-align:center; border-bottom:1px solid #eee;">
                <button onclick="deleteSingle(${h.idx})" style="background:none; color:red; width:auto; padding:0;"><i class="fas fa-trash"></i></button>
            </td>
        </tr>
    `).join('') || '<tr><td colspan="4" style="text-align:center; padding:20px; color:#999;">No records found.</td></tr>';
}

function deleteSingle(i) {
    if(!confirm("Delete this record?")) return;
    let data = JSON.parse(localStorage.getItem('geodesy_ultimate_db') || '[]');
    data.splice(i, 1);
    localStorage.setItem('geodesy_ultimate_db', JSON.stringify(data));
    refreshHistory();
}

function clearAllData() {
    if(!confirm("WIPE ALL DATA? This cannot be undone.")) return;
    localStorage.removeItem('geodesy_ultimate_db');
    refreshHistory();
}

function exportCSV() {
    let data = JSON.parse(localStorage.getItem('geodesy_ultimate_db') || '[]');
    let csv = "Name,Score,Date\n" + data.map(h => `${h.n},${h.s},${h.d}`).join('\n');
    let a = document.createElement('a');
    a.href = URL.createObjectURL(new Blob([csv], {type:'text/csv'}));
    a.download = 'Geodesy_Results.csv';
    a.click();
}

function exitExam() {
    if(confirm("Quit exam? Progress will be lost.")) location.reload();
}
</script>
</body>
</html>
